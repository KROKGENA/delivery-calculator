// ... HTML и Leaflet код остаются прежними, важна только правка buildRoute ...

async function buildRoute(from, to) {
    const apiKey = "5b3ce3597851110001cf62480793bada4b33404496495e4e014c8e3d";

    try {
        const response = await axios.post("https://api.openrouteservice.org/v2/directions/driving-car/geojson",
            { coordinates: [[from[1], from[0]], [to[1], to[0]]] },
            { headers: { Authorization: apiKey, "Content-Type": "application/json" } });

        const geojson = response.data;
        if (routeLine) map.removeLayer(routeLine);
        routeLine = L.geoJSON(geojson, { style: { color: "blue", weight: 4 } }).addTo(map);

        const routeCoords = geojson.features[0].geometry.coordinates;
        let routeDistanceFromRadius = 0;
        let enteredRadius = false;
        const center = turf.point([from[1], from[0]]);

        for (let i = 1; i < routeCoords.length; i++) {
            const p1 = turf.point(routeCoords[i - 1]);
            const p2 = turf.point(routeCoords[i]);
            const segment = turf.lineString([routeCoords[i - 1], routeCoords[i]]);

            const distFromCenter1 = turf.distance(center, p1, { units: 'kilometers' });
            const distFromCenter2 = turf.distance(center, p2, { units: 'kilometers' });

            if (distFromCenter1 > 40 || distFromCenter2 > 40) {
                const segmentLength = turf.length(segment, { units: 'kilometers' });
                routeDistanceFromRadius += segmentLength;
            }
        }

        const weight = parseInt(document.getElementById("weight").value);
        const format = document.getElementById("format").value;
        const loadingType = document.getElementById("loadingType").value;
        const adjustedWeight = (format === "mixed") ? weight * 1.5 : weight;

        const suitableVehicles = vehicles.filter(v =>
            v.maxWeight >= adjustedWeight &&
            (loadingType === "any" || v.load === loadingType)
        );

        if (!suitableVehicles.length) {
            document.getElementById("result").innerText = "Нет подходящего транспорта";
            return;
        }

        const selected = suitableVehicles[0];
        const overDistance = routeDistanceFromRadius;
        const total = selected.min + overDistance * selected.perKm;

        document.getElementById("result").innerText =
            `Общая длина маршрута: ${(geojson.features[0].properties.summary.distance / 1000).toFixed(2)} км\nТип: ${selected.type}\nВ пределах 40 км: ${selected.min} ₽` +
            (overDistance > 0 ? `\nЗа пределами 40 км: ${overDistance.toFixed(2)} км × ${selected.perKm} ₽ = ${(overDistance * selected.perKm).toFixed(2)} ₽` : "") +
            `\nИтог: ${total.toFixed(2)} ₽`;

    } catch (error) {
        alert("Не удалось построить маршрут");
        console.error(error);
    }
}
