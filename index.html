<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Калькулятор доставки (OpenStreetMap)</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        label { display: block; margin-top: 10px; }
        input, select { width: 300px; padding: 5px; }
        button { margin-top: 15px; padding: 10px 20px; }
        #map { width: 100%; height: 400px; margin-top: 20px; }
        #result { margin-top: 20px; font-size: 16px; }
    </style>
</head>
<body>
    <h2>Калькулятор доставки (на базе OpenStreetMap)</h2>

    <label>Вес (в кг):</label>
    <input id="weight" type="number" value="500">

    <label>Формат плитки:</label>
    <select id="format">
        <option value="standard">Стандартный</option>
        <option value="large">Крупный</option>
        <option value="mixed">Микс</option>
    </select>

    <label><input type="radio" name="option" value="side" id="sideLoading"> Боковая загрузка</label>
    <label><input type="radio" name="option" value="top" id="topLoading"> Верхняя загрузка</label>
    <label><input type="radio" name="option" value="hydro" id="hydrolift"> Гидролифт</label>
    <label><input type="radio" name="option" value="manip" id="manipulator"> Манипулятор</label>

    <label>Адрес клиента:</label>
    <input id="address" type="text" placeholder="Например: Москва, ул. Тверская, 1">
    <button id="geocode">Определить координаты</button>

    <p>Кликните на карту, чтобы выбрать точку клиента. Склад по умолчанию: 54.907129, 38.054109</p>
    <div id="map"></div>
    <div id="result"></div>

    <script>
    const warehouseCoords = [54.907129, 38.054109];
    let clientMarker, routeLine, radiusCircle;
    const map = L.map('map').setView(warehouseCoords, 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    L.marker(warehouseCoords).addTo(map).bindPopup("Склад").openPopup();
    radiusCircle = L.circle(warehouseCoords, {
        radius: 40000,
        color: 'green',
        fillOpacity: 0.1
    }).addTo(map);

    const vehicles = [
        { type: "а/м до 1т", maxWeight: 1000, side: true, top: true, hydro: false, manip: false, min: 4000, perKm: 100 },
        { type: "а/м до 1.5т", maxWeight: 1500, side: true, top: true, hydro: false, manip: false, min: 4000, perKm: 100 },
        { type: "а/м до 3т", maxWeight: 3000, side: true, top: true, hydro: false, manip: false, min: 4500, perKm: 112.5 },
        { type: "а/м 5т", maxWeight: 5000, side: true, top: true, hydro: false, manip: false, min: 5000, perKm: 144 },
        { type: "а/м 5т гидролифт", maxWeight: 5000, side: false, top: false, hydro: true, manip: false, min: 6000, perKm: 154 },
        { type: "а/м 10т", maxWeight: 10000, side: true, top: true, hydro: false, manip: false, min: 8000, perKm: 210 },
        { type: "Еврофура 20т", maxWeight: 20000, side: true, top: true, hydro: false, manip: false, min: 10000, perKm: 250 },
        { type: "Манипулятор 5т", maxWeight: 5000, side: false, top: false, hydro: false, manip: true, min: 15000, perKm: 240 },
        { type: "Манипулятор 10т", maxWeight: 10000, side: false, top: false, hydro: false, manip: true, min: 20000, perKm: 240 },
        { type: "Манипулятор 15т", maxWeight: 15000, side: false, top: false, hydro: false, manip: true, min: 25000, perKm: 240 },
    ];

    map.on('click', function(e) {
        const latlng = e.latlng;
        if (clientMarker) map.removeLayer(clientMarker);
        if (routeLine) map.removeLayer(routeLine);

        clientMarker = L.marker(latlng).addTo(map).bindPopup("Клиент").openPopup();

        reverseGeocode(latlng.lat, latlng.lng);
        buildRoute(warehouseCoords, [latlng.lat, latlng.lng]);
    });

    document.getElementById("geocode").addEventListener("click", async () => {
        const address = document.getElementById("address").value;
        if (!address) return;

        const response = await axios.get("https://nominatim.openstreetmap.org/search", {
            params: {
                q: address,
                format: "json",
                limit: 1
            }
        });

        if (response.data && response.data.length > 0) {
            const { lat, lon } = response.data[0];
            map.setView([lat, lon], 14);
            if (clientMarker) map.removeLayer(clientMarker);
            if (routeLine) map.removeLayer(routeLine);

            clientMarker = L.marker([lat, lon]).addTo(map).bindPopup("Клиент").openPopup();
            buildRoute(warehouseCoords, [lat, lon]);
        } else {
            alert("Адрес не найден");
        }
    });

    async function reverseGeocode(lat, lon) {
        const response = await axios.get("https://nominatim.openstreetmap.org/reverse", {
            params: { lat, lon, format: "json" }
        });
        document.getElementById("address").value = response.data?.display_name || "Не удалось определить адрес";
    }

    async function buildRoute(from, to) {
        const apiKey = "5b3ce3597851110001cf62480793bada4b33404496495e4e014c8e3d";

        try {
            const response = await axios.post(
                "https://api.openrouteservice.org/v2/directions/driving-car/geojson",
                { coordinates: [[from[1], from[0]], [to[1], to[0]]] },
                { headers: { Authorization: apiKey, "Content-Type": "application/json" } }
            );

            const geojson = response.data;
            routeLine = L.geoJSON(geojson, { style: { color: "blue", weight: 4 } }).addTo(map);

            const distanceKm = geojson.features[0].properties.summary.distance / 1000;
            const weight = parseInt(document.getElementById("weight").value);
            const format = document.getElementById("format").value;
            const option = document.querySelector('input[name="option"]:checked')?.value;

            const side = option === "side";
            const top = option === "top";
            const hydro = option === "hydro";
            const manip = option === "manip";

            const adjustedWeight = (format === "mixed") ? weight * 1.5 : weight;
            const filtered = vehicles.filter(v =>
                v.maxWeight >= adjustedWeight &&
                (!side || v.side) &&
                (!top || v.top) &&
                (!hydro || v.hydro) &&
                (!manip || v.manip)
            );

            if (!filtered.length) {
                document.getElementById("result").innerText = "Нет подходящего транспорта";
                return;
            }

            const selected = filtered[0];
            const clientPoint = turf.point([to[1], to[0]]);
            const warehouseCircle = turf.circle([from[1], from[0]], 40, { units: 'kilometers' });
            const isInside = turf.booleanPointInPolygon(clientPoint, warehouseCircle);

            const total = isInside ? selected.min : selected.min + (distanceKm - 40) * selected.perKm;

            document.getElementById("result").innerText = `Маршрут: ${distanceKm.toFixed(2)} км. Транспорт: ${selected.type}. Стоимость: ${total.toFixed(2)} ₽`;
        } catch (error) {
            alert("Не удалось построить маршрут");
            console.error(error);
        }
    }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
</body>
</html>
